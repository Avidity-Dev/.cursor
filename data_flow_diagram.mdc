---
description: How data flow through this app.
globs: 
alwaysApply: false
---
# HCP-HCO Matching System Data Flow

## High-Level Flow

```
┌────────────────┐     ┌─────────────────┐     ┌────────────────┐     ┌─────────────────┐
│                │     │                 │     │                │     │                 │
│  Input Tables  │────►│  Preprocessing  │────►│ Match Process  │────►│  Output Tables  │
│                │     │                 │     │                │     │                 │
└────────────────┘     └─────────────────┘     └────────────────┘     └─────────────────┘
```

## Detailed Data Flow

```
┌─────────────────────┐
│  Input Data Sources │
└──────────┬──────────┘
           │
           ▼
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ┌────────────────┐   ┌────────────────┐   ┌────────────────┐   │
│  │                │   │                │   │                │   │
│  │  OPENDATA_HCPS │   │ OPENDATA_HCOS  │   │ OPENDATA_AFFILS│   │
│  │                │   │                │   │                │   │
│  └───────┬────────┘   └────────┬───────┘   └────────┬───────┘   │
│          │                     │                    │           │
│  ┌───────▼────────┐   ┌────────▼───────┐   ┌────────▼───────┐   │
│  │                │   │                │   │                │   │
│  │  HCO_HIERARCHY │   │  ADDRESSES     │   │  OVERRIDES     │   │
│  │                │   │                │   │                │   │
│  └───────┬────────┘   └────────┬───────┘   └────────┬───────┘   │
│          │                     │                    │           │
└──────────┼─────────────────────┼────────────────────┼───────────┘
           │                     │                    │
           ▼                     ▼                    ▼
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ┌───────────────────────────────────────────────────────┐      │
│  │                  Data Preprocessing                    │      │
│  │                                                        │      │
│  │  ┌────────────┐   ┌─────────────┐   ┌───────────────┐ │      │
│  │  │ HCP Address│   │HCO Hierarchy│   │Address Geocode│ │      │
│  │  │ Processing │   │ Processing  │   │  Validation   │ │      │
│  │  └────────────┘   └─────────────┘   └───────────────┘ │      │
│  │                                                        │      │
│  └───────────────────────────┬───────────────────────────┘      │
│                              │                                   │
└──────────────────────────────┼───────────────────────────────────┘
                               │
                               ▼
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ┌───────────────────────────────────────────────────────┐      │
│  │                  Matching Process                      │      │
│  │                                                        │      │
│  │  ┌────────────┐   ┌─────────────┐   ┌───────────────┐ │      │
│  │  │ Geographic │   │  Network    │   │ Tie-Breaking  │ │      │
│  │  │  Matching  │   │  Matching   │   │    Logic      │ │      │
│  │  └────────────┘   └─────────────┘   └───────────────┘ │      │
│  │                                                        │      │
│  └───────────────────────────┬───────────────────────────┘      │
│                              │                                   │
└──────────────────────────────┼───────────────────────────────────┘
                               │
                               ▼
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ┌───────────────────────────────────────────────────────┐      │
│  │                  Results Processing                    │      │
│  │                                                        │      │
│  │  ┌────────────┐   ┌─────────────┐   ┌───────────────┐ │      │
│  │  │  Primary   │   │ Owner       │   │  Override     │ │      │
│  │  │Assignment  │   │Relationship │   │  Application  │ │      │
│  │  └────────────┘   └─────────────┘   └───────────────┘ │      │
│  │                                                        │      │
│  └───────────────────────────┬───────────────────────────┘      │
│                              │                                   │
└──────────────────────────────┼───────────────────────────────────┘
                               │
                               ▼
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ┌───────────────────────────────────────────────────────┐      │
│  │                  Output Tables                         │      │
│  │                                                        │      │
│  │  ┌────────────────────────┐  ┌────────────────────┐   │      │
│  │  │AFFIL_HCP_HCO_PRIMARY_  │  │AFFIL_BACKUP_ADDR_  │   │      │
│  │  │        AFFIL          │  │    SELECTION       │   │      │
│  │  └────────────────────────┘  └────────────────────┘   │      │
│  │                                                        │      │
│  │  ┌────────────────────────┐                           │      │
│  │  │AFFIL_HCO_PRIMARY_OWNER │                           │      │
│  │  └────────────────────────┘                           │      │
│  │                                                        │      │
│  └───────────────────────────────────────────────────────┘      │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## Match Type Decision Tree

```
Is there a manual override? ───Yes──► Apply Override
         │
         No
         │
         ▼
Distance ≤ 0.2 AND          ───Yes──► Clear Match
Key Network AND Exact Address
         │
         No
         │
         ▼
Distance ≤ 0.2 AND Key Network ───Yes──► Top Network Match
         │
         No
         │
         ▼
Single Record? ───Yes──► Single Record Match
         │
         No
         │
         ▼
Exact Address? ───Yes──► Exact Address Match
         │
         No
         │
         ▼
Distance ≤ 0.2? ───Yes──► Single Close HCO Match
         │
         No
         │
         ▼
      No Match
```


## Key Data Transformations with Snowpark

1. **HCP Data Preparation**
   - Create Snowpark DataFrame from HCP table
   - Join with ADDRESS DataFrame on ENTITY_VID__V
   - Join with AFFILS DataFrame on HCP_VID__V
   - Apply column transformations using DataFrame operations

2. **HCO Hierarchy Resolution**
   - Use Snowpark window functions to find max PATH_DISTANCE for each ENTITY_VID__V
   - Identify top parent organization using DataFrame operations
   - Handle multiple-owner scenarios with DataFrame aggregations

3. **Address Comparison**
   - Implement Haversine distance as Snowpark UDF
   - Apply distance calculations to DataFrame rows
   - Filter by distance threshold using DataFrame operations

4. **Match Assignment**
   - Use Snowpark transformations to apply match type hierarchy
   - Record match criteria in DataFrame columns
   - Generate final assignment DataFrames and save to tables
